<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<script src="config.js"></script>
<title>Treatment Price Master</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  font-family:"Segoe UI",Arial;
  background:#f1f5f9;
  margin:0;
  padding:30px;
}
.container{
  max-width:900px;
  margin:auto;
  background:white;
  padding:25px;
  border-radius:14px;
  box-shadow:0 15px 35px rgba(0,0,0,.15);
}
h2{
  margin-top:0;
  color:#0f766e;
  display:flex;
  align-items:center;
  gap:10px;
}
.form{
  display:grid;
  grid-template-columns:2fr auto;
  gap:12px;
  margin-bottom:25px;
}
input{
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
.save-btn{background:#0f766e;color:white}
.update-btn{background:#2563eb;color:white}
.delete-btn{background:#dc2626;color:white;margin-left:6px}
.badge{
  background:#e6f2f1;
  color:#065f46;
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
}
.back-btn{
  background:#6b7280;
  color:white;
  border:none;
  padding:10px 18px;
  border-radius:10px;
  cursor:pointer;
  margin-top:15px;
}
.price-input{
  width:120px;
  padding:6px;
}
table{width:100%;border-collapse:collapse}
th{
  background:#0f766e;
  color:white;
  padding:12px;
  text-align:left;
}
td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}
</style>
</head>

<body>

<div class="container">

<h2><i class="fa-solid fa-notes-medical"></i> Treatment Price Master</h2>

<!-- ADD NEW -->
<div class="form">
  <input id="treatmentName" placeholder="Treatment Name">
  <button class="save-btn" onclick="saveTreatment()">
    <i class="fa-solid fa-plus"></i> Save
  </button>
</div>

<table>
  <thead>
    <tr>
      <th>Treatment</th>
      <th>Price / Day (₹)</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="list"></tbody>
</table>

<button class="back-btn" onclick="goBack()">⬅ Back to Dashboard</button>

</div>

<script>
const token = localStorage.getItem("token");
const list = document.getElementById("list");

if(!token){
  alert("Session expired");
location.href="index.html";
}

/* LOAD */
async function loadTreatments(){
  const res = await fetch(`${API}/treatments`,{
    headers:{ Authorization:`Bearer ${token}` }
  });

  if(!res.ok){
    alert("Failed to load treatments");
    return;
  }

  const data = await res.json();
  list.innerHTML = data.map(t=>`
    <tr>
      <td><b>${t.name}</b> <span class="badge">Active</span></td>
      <td>
        <input class="price-input"
          id="price-${t._id}"
          type="number"
          value="${t.pricePerDay}">
      </td>
      <td>
        <button class="update-btn"
          onclick="updateTreatment('${t._id}')">
          <i class="fa-solid fa-pen"></i>
        </button>
        <button class="delete-btn"
          onclick="deleteTreatment('${t._id}')">
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join("");
}

/* SAVE */
async function saveTreatment(){
  const name = treatmentName.value.trim();

  // ✅ FORM VALIDATIONS
  if(!name || !name.length){
    alert("❌ Please enter treatment name");
    return;
  }

  if(name.length < 3) {
    alert("❌ Treatment name must be at least 3 characters");
    return;
  }

  try {
    const res = await fetch(`${API}/treatments`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:`Bearer ${token}`
      },
      body:JSON.stringify({
        name: name,
        pricePerDay: 0
      })
    });

    if(!res.ok){
      const error = await res.json();
      alert(error.message || "❌ Treatment already exists");
      return;
    }

    alert("✅ Treatment added successfully");
    treatmentName.value="";
    loadTreatments();
  } catch (error) {
    console.error(error);
    alert("❌ Error saving treatment. Check console.");
  }
}

/* UPDATE */
async function updateTreatment(id){
  const newPrice = document.getElementById(`price-${id}`).value;
  const priceVal = Number(newPrice);

  // ✅ FORM VALIDATION
  if(!priceVal || priceVal <= 0){
    alert("❌ Please enter a valid price (₹1 or more)");
    return;
  }

  if(priceVal > 100000) {
    alert("❌ Price cannot exceed ₹100,000");
    return;
  }

  try {
    const res = await fetch(`${API}/treatments/${id}`,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        Authorization:`Bearer ${token}`
      },
      body:JSON.stringify({ pricePerDay: priceVal })
    });

    if(!res.ok) {
      alert("❌ Failed to update treatment price");
      return;
    }

    alert("✅ Treatment price updated");
    loadTreatments();
  } catch (error) {
    console.error(error);
    alert("❌ Error updating treatment. Check console.");
  }
}

/* DELETE */
async function deleteTreatment(id){
  if(!confirm("⚠️ Are you sure you want to delete this treatment? This action cannot be undone.")) return;

  try {
    const res = await fetch(`${API}/treatments/${id}`,{
      method:"DELETE",
      headers:{ Authorization:`Bearer ${token}` }
    });

    if(!res.ok) {
      alert("❌ Failed to delete treatment");
      return;
    }

    alert("✅ Treatment deleted successfully");
    loadTreatments();
  } catch (error) {
    console.error(error);
    alert("❌ Error deleting treatment. Check console.");
  }
}

function goBack(){
  location.href="dashboard.html";
}

loadTreatments();
</script>

</body>
</html>
