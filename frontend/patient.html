<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Patient Billing & Treatment</title>
<script src="config.js"></script>

<style>
:root{
  --primary:#0e7490;
  --primary-dark:#155e75;
  --secondary:#06b6d4;
  --danger:#dc2626;
  --bg:#e0f2fe;
  --card:#ffffff;
  --muted:#64748b;
  --text:#0f172a;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Segoe UI",system-ui,Arial;
  background:linear-gradient(180deg,#e0f2fe,#f8fafc);
  min-height:100vh;
  padding:30px;
  color:var(--text);
}

.container{
  max-width:1000px;
  margin:auto;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
}
.topbar h1{
  margin:0;
  font-size:26px;
  color:var(--primary-dark);
}
.back{
  background:#475569;
  color:white;
  border:none;
  padding:10px 18px;
  border-radius:10px;
  cursor:pointer;
}

.card{
  background:var(--card);
  border-radius:18px;
  padding:26px;
  box-shadow:0 20px 45px rgba(0,0,0,.08);
  margin-bottom:24px;
}

.patient-info{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}
.info-box{
  background:#f8fafc;
  border-radius:14px;
  padding:16px;
}
.info-box span{
  font-size:13px;
  color:var(--muted);
}
.info-box b{
  font-size:16px;
}

.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  margin-top:20px;
}
.stat{
  border-radius:16px;
  padding:18px;
  text-align:center;
}
.stat.total{background:#ecfeff}
.stat.paid{background:#f0fdf4}
.stat.due{background:#fef2f2}
.stat h3{margin:0;font-size:14px;color:var(--muted)}
.stat span{font-size:26px;font-weight:700}

.section h2{
  margin-bottom:12px;
  color:var(--primary-dark);
  font-size:20px;
}

input,textarea{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #cbd5e1;
  margin-top:8px;
  font-size:15px;
}
textarea{resize:none}

button{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  font-size:15px;
  cursor:pointer;
  margin-top:12px;
}
.primary{background:var(--primary);color:white}
.secondary{background:var(--secondary);color:white}
.invoice{background:#2563eb;color:white}
.danger{background:var(--danger);color:white}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th{
  background:var(--primary);
  color:white;
  padding:14px;
}
td{
  padding:12px;
  text-align:center;
  border-bottom:1px solid #e5e7eb;
}

.history{
  background:#f8fafc;
  border-radius:14px;
  padding:18px;
}
.history-item{
  padding:10px 0;
  border-bottom:1px dashed #cbd5e1;
  font-size:14px;
}

.actions{
  display:flex;
  gap:12px;
}
</style>
</head>

<body>

<div class="container">

  <div class="topbar">
    <h1>üè• Patient Billing & Treatment</h1>
    <button class="back" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <!-- PATIENT INFO -->
  <div class="card">
    <div class="patient-info">
      <div class="info-box">
        <span>Patient Name</span>
        <b id="pname">‚Äî</b>
      </div>
      <div class="info-box">
        <span>Phone</span>
        <b id="pphone">‚Äî</b>
      </div>
      <div class="info-box">
        <span>Status</span>
        <b id="pstatus">‚Äî</b>
      </div>
    </div>

    <div class="stats">
      <div class="stat total">
        <h3>Total</h3>
        <span>‚Çπ <span id="total">0</span></span>
      </div>
      <div class="stat paid">
        <h3>Paid</h3>
        <span>‚Çπ <span id="paid">0</span></span>
      </div>
      <div class="stat due">
        <h3>Due</h3>
        <span>‚Çπ <span id="due">0</span></span>
      </div>
    </div>
  </div>

  <!-- PAYMENT -->
  <div class="card section">
    <h2>üí≥ Add Payment</h2>
    <input id="addPaid" type="number" min="1" step="1" placeholder="Enter payment amount" required>
    <textarea id="notes" rows="3" placeholder="Notes (optional)"></textarea>
    <button class="primary" onclick="savePayment()" id="savePaymentBtn">Save Payment</button>
  </div>

  <!-- TREATMENTS -->
  <div class="card section">
    <h2>ü©∫ Treatment Details</h2>
<div style="display:grid; gap:12px; margin-bottom:12px">

  <div>
    <label for="startDate" style="font-weight:600">
      üü¢ Treatment Start Date
    </label>
    <input
      type="date"
      id="startDate"
    />
  </div>

  <div>
    <label for="endDate" style="font-weight:600">
      üî¥ Treatment End Date
    </label>
    <input
      type="date"
      id="endDate"
    />
  </div>

</div>

    <table>
      <thead>
        <tr>
          <th>Treatment</th>
          <th>Price / Day</th>
          <th>Days</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="treatmentTable"></tbody>
    </table>

    <p style="margin-top:10px;font-size:16px">
      <b>Visit Total: ‚Çπ <span id="grandTotal">0</span></b>
    </p>

    <button class="secondary" onclick="saveTreatments()">üíæ Save Treatments</button>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <button class="invoice" onclick="downloadInvoice()">üìÑ Invoice</button>
    <button class="danger" onclick="deletePatient()">üóë Delete</button>
  </div>

  <div class="section">
  <h3>üìú Invoice History</h3>
  <div id="invoiceHistory"></div>
</div>

  <!-- HISTORY -->
  <div class="card section">
    <h2>üìú Payment History</h2>
    <div id="history" class="history"></div>
  </div>


</div>

<script>
const token = localStorage.getItem("token");
const id = new URLSearchParams(location.search).get("id");

if(!token) location.href="index.html";
if(!id){ 
  alert("Invalid patient"); 
  location.href="dashboard.html"; 
}

const pname   = document.getElementById("pname");
const pphone  = document.getElementById("pphone");
const pstatus = document.getElementById("pstatus");

const totalEl = document.getElementById("total");
const paidEl  = document.getElementById("paid");
const dueEl   = document.getElementById("due");
const historyDiv = document.getElementById("history");
const table = document.getElementById("treatmentTable");

let treatmentPrices = {};

async function loadTreatmentMaster(){
  const res = await fetch(`${API}/treatments`,{
    headers:{ Authorization:`Bearer ${token}` }
  });
  const data = await res.json();
  treatmentPrices = {};
  data.forEach(t => treatmentPrices[t.name] = t.pricePerDay);
}

function recalc(){
  let total = 0;
  document.querySelectorAll("#treatmentTable tr").forEach(r=>{
    const days = +r.querySelector(".daysInput").value || 0;
    const price = +r.querySelector(".priceInput").value || 0;
    const amt = days * price;
    r.querySelector(".rowTotal").innerText = "‚Çπ" + amt;
    total += amt;
  });
  document.getElementById("grandTotal").innerText = total;
}

async function loadPatient(){
  await loadTreatmentMaster();

  const res = await fetch(`${API}/patient/${id}`,{
    headers:{ Authorization:`Bearer ${token}` }
  });
  const p = await res.json();

  pname.innerText = p.name;
  pphone.innerText = p.phone;
  pstatus.innerText = p.status;

  totalEl.innerText = p.totalAmount || 0;
  paidEl.innerText = p.paidAmount || 0;
  dueEl.innerText  = (p.totalAmount || 0) - (p.paidAmount || 0);

  table.innerHTML = "";

  if(p.treatmentHistory?.length){
    p.treatmentHistory.at(-1).treatments.forEach(t=>{
      table.innerHTML += `
        <tr>
          <td>${t.treatmentName}</td>
          <td><input type="number" class="priceInput" value="${t.pricePerDay}" min="0" step="1" oninput="recalc()" style="width:80px;padding:8px;border-radius:6px;border:1px solid #cbd5e1;"></td>
          <td><input type="number" class="daysInput" value="${t.days}" min="1" oninput="recalc()" style="width:60px;padding:8px;border-radius:6px;border:1px solid #cbd5e1;"></td>
          <td class="rowTotal">‚Çπ${t.totalAmount}</td>
        </tr>`;
    });
  }
  // ‚úÖ FIRST VISIT ‚Äì LOAD FROM TREATMENT MASTER
if (!p.treatmentHistory?.length) {
  Object.keys(treatmentPrices).forEach(name => {
    const price = treatmentPrices[name];

    table.innerHTML += `
      <tr>
        <td>${name}</td>
        <td><input type="number" class="priceInput" value="${price || 0}" min="0" step="1" oninput="recalc()" style="width:80px;padding:8px;border-radius:6px;border:1px solid #cbd5e1;"></td>
        <td><input type="number" class="daysInput" min="1" step="1" placeholder="0" oninput="recalc()" style="width:60px;padding:8px;border-radius:6px;border:1px solid #cbd5e1;"></td>
        <td class="rowTotal">‚Çπ0</td>
      </tr>
    `;
  });
}


  recalc();

  historyDiv.innerHTML = "";
  p.paymentHistory?.forEach((h, idx)=>{
    historyDiv.innerHTML += `
      <div class="history-item" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          ${h.entryType} ‚Äì ‚Çπ${h.amount}
          <br><small>${new Date(h.date).toLocaleString()}</small>
        </div>
        <button class="danger" style="padding:8px 12px; font-size:13px;" onclick="deletePayment(${idx})">üóë Delete</button>
      </div>`;
  });
}

async function savePayment(){
  const amt = Number(document.getElementById("addPaid").value);
  const notes = document.getElementById("notes").value;

  // ‚úÖ FORM VALIDATION
  if (!amt || amt <= 0) {
    alert("‚ùå Please enter a valid payment amount");
    return;
  }

  if (amt > 100000) {
    alert("‚ùå Payment amount cannot exceed ‚Çπ100,000");
    return;
  }

  try {
    const response = await fetch(`${API}/patient/${id}`,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        Authorization:`Bearer ${token}`
      },
      body:JSON.stringify({ 
        addPaid: amt, 
        notes
      })
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`‚ùå ${error.message || 'Failed to save payment'}`);
      return;
    }

    alert("‚úÖ Payment saved successfully");
    document.getElementById("addPaid").value = "";
    document.getElementById("notes").value = "";
    loadPatient();
  } catch (error) {
    console.error(error);
    alert("‚ùå Error saving payment. Check console.");
  }
}


async function saveTreatments(){
  let total=0, rows=[];
  const startDate = document.getElementById("startDate").value;
  const endDate   = document.getElementById("endDate").value;

  // ‚úÖ FORM VALIDATION
  if (!startDate || !endDate) {
    alert("‚ùå Please select both treatment start and end dates");
    return;
  }

  if (new Date(startDate) >= new Date(endDate)) {
    alert("‚ùå End date must be after start date");
    return;
  }

  document.querySelectorAll("#treatmentTable tr").forEach(r=>{
    const name = r.children[0].innerText;
    const price = +r.querySelector(".priceInput").value;
    const days = +r.querySelector(".daysInput").value;
    const amt = price * days;

    if (days > 0) {
      rows.push({
        treatmentName: name,
        pricePerDay: price,
        days,
        totalAmount: amt
      });
      total += amt;
    }
  });

  if (!rows.length) {
    alert("‚ùå Enter days for at least one treatment");
    return;
  }

  try {
    const response = await fetch(`${API}/patient/${id}/treatments/add`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:`Bearer ${token}`
      },
      body: JSON.stringify({
        treatments: rows,
        totalAmount: total,
        startDate: startDate,
        endDate: endDate
      })
    });

    if (!response.ok) {
      alert("‚ùå Failed to save treatments");
      return;
    }

    alert("‚úÖ Treatments saved successfully");
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    
    window.scrollTo({ top: 0, behavior: "smooth" });
    loadPatient();
  } catch (error) {
    console.error(error);
    alert("‚ùå Error saving treatments. Check console.");
  }
}
function downloadInvoice(patientId = id, invoiceNumber = "") {
  const token = localStorage.getItem("token");
  window.open(
    `${API}/invoice/${patientId}?token=${token}&invoice=${invoiceNumber}`
  );
}

function goBack(){
  location.href="dashboard.html";
}

async function deletePayment(paymentIndex){
  if(confirm("‚ö†Ô∏è Are you sure you want to delete this payment?")){
    try {
      const response = await fetch(`${API}/patient/${id}/payment/${paymentIndex}`,{
        method:"DELETE",
        headers:{ Authorization:`Bearer ${token}` }
      });

      if (!response.ok) {
        const error = await response.json();
        alert(`‚ùå ${error.message || 'Failed to delete payment'}`);
        return;
      }

      alert("‚úÖ Payment deleted successfully");
      loadPatient();
    } catch (error) {
      console.error(error);
      alert("‚ùå Error deleting payment. Check console.");
    }
  }
}

async function deletePatient(){
  if(confirm("‚ö†Ô∏è Are you sure you want to delete this patient? This action cannot be undone.")){
    try {
      const response = await fetch(`${API}/patient/${id}`,{
        method:"DELETE",
        headers:{ Authorization:`Bearer ${token}` }
      });

      if (!response.ok) {
        alert("‚ùå Failed to delete patient");
        return;
      }

      alert("‚úÖ Patient deleted successfully");
      location.href="dashboard.html";
    } catch (error) {
      console.error(error);
      alert("‚ùå Error deleting patient. Check console.");
    }
  }
}
async function loadInvoiceHistory(patientId) {
  const res = await fetch(
    `${API}/patient/${patientId}/invoices`,
    { headers: { Authorization: `Bearer ${token}` } }
  );

  const invoices = await res.json();
  const box = document.getElementById("invoiceHistory");

  if (!invoices.length) {
    box.innerHTML = "<p>No invoices generated yet</p>";
    return;
  }

box.innerHTML = invoices.map(inv => `
  <div style="padding:10px;border-bottom:1px solid #e5e7eb">
    <b>${inv.invoiceNumber}</b><br>

    üóì Start: ${inv.treatmentStartDate}<br>
    üóì End: ${inv.treatmentEndDate}<br>

    üí∞ Total: ‚Çπ${inv.totalAmount} |
    Paid: ‚Çπ${inv.paidAmount} |
    Due: ‚Çπ${inv.dueAmount}<br><br>

    <button onclick="downloadInvoice('${patientId}', '${inv.invoiceNumber}')">
      üìÑ Download
    </button>

    <button
      style="margin-left:8px;background:#dc2626;color:white"
      onclick="deleteInvoice('${patientId}', '${inv.invoiceNumber}')">
      üóë Delete
    </button>
  </div>
`).join("");
}
async function deleteInvoice(patientId, invoiceNumber) {
  if (!confirm("Delete this invoice permanently?")) return;

  await fetch(
    `${API}/patient/${patientId}/invoice/${invoiceNumber}`,
    {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`
      }
    }
  );

  alert("Invoice deleted");
  loadInvoiceHistory(patientId);
}


loadInvoiceHistory(id);

loadPatient();
</script>

</body>
</html>
