<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hospital Dashboard</title>
<script src="config.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --primary:#0f766e;
  --secondary:#14b8a6;
  --bg:#e6f2f1;
  --card:#ffffff;
  --text:#1f2937;
}
.dark{
  --bg:#1f2937;
  --card:#111827;
  --text:#f9fafb;
}
*{box-sizing:border-box}

body{
  transition: background 0.3s ease, color 0.3s ease;
}

/* Dark mode background override */
body.dark{
  background:
    linear-gradient(rgba(31,41,55,.95),rgba(31,41,55,.95)),
    url("https://images.unsplash.com/photo-1586773860418-d37222d8fce3");
}

/* Header dark */
body.dark .header{
  background:linear-gradient(135deg,#064e3b,#0f766e);
}

/* Cards dark */
body.dark .stat,
body.dark .card,
body.dark .filter{
  background:#111827;
  box-shadow:0 10px 25px rgba(0,0,0,.6);
}

/* Inputs dark */
body.dark input,
body.dark select{
  background:#1f2937;
  color:#f9fafb;
  border:1px solid #374151;
}

body{
  margin:0;
  font-family:"Segoe UI", Arial;
  color:var(--text);
  background:
    linear-gradient(rgba(230,242,241,.9),rgba(230,242,241,.9)),
    url("https://images.unsplash.com/photo-1586773860418-d37222d8fce3");
  background-size:cover;
  background-attachment:fixed;
}

/* ================= HEADER ================= */
.header{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:white;
  padding:18px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header h2{margin:0}
.header button{
  border:none;
  padding:9px 14px;
  border-radius:8px;
  cursor:pointer;
  margin-left:6px;
  color:white;
}
.darkbtn{background:#065f46}
.doctor{background:#7c3aed}
.appoint{background:#059669}
.reports{background:#2563eb}
.logout{background:#dc2626}

/* ================= STATS ================= */
.stats{
  max-width:1200px;
  margin:30px auto;
  padding:0 20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}
.stat{
  background:var(--card);
  border-radius:18px;
  padding:22px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
  border-left:6px solid var(--primary);
}
.stat h3{margin:0;font-size:26px}
.stat p{margin:6px 0 0;color:#6b7280}

/* ================= REPORTS ================= */
.section{
  max-width:1200px;
  margin:0 auto 30px;
  padding:0 20px;
}
.section h3{
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:10px;
}

.report-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:18px;
}
.report-card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  box-shadow:0 8px 22px rgba(0,0,0,.1);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.report-card h4{margin:0;font-size:15px}
.report-card p{margin:4px 0 0;font-size:12px;color:#6b7280}
.report-card button{
  border:none;
  padding:10px 14px;
  border-radius:10px;
  font-weight:600;
  color:white;
  cursor:pointer;
}
.payment{background:#059669}
.doctorpdf{background:#7c3aed}

/* ================= FILTER ================= */
.filter{
  max-width:1200px;
  margin:0 auto 20px;
  background:var(--card);
  padding:18px;
  border-radius:14px;
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr;
  gap:12px;
}
.filter input,.filter select,.filter button{
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
}
.filter button{
  background:var(--primary);
  color:white;
  border:none;
  font-weight:600;
}

/* ================= PATIENT LIST ================= */
.container{
  max-width:1200px;
  margin:auto;
  padding:0 20px 40px;
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:18px;
  margin-bottom:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.card button{
  border:none;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
.view-btn{background:var(--primary);color:white}
.edit-btn{background:#f59e0b;color:white;margin-left:6px}
.edit-btn:hover{background:#d97706}
.delete-btn{background:#dc2626;color:white;margin-left:6px}
.delete-btn:hover{background:#b91c1c}
.status{
  padding:5px 14px;
  border-radius:20px;
  color:white;
  font-size:12px;
}
.Ongoing{background:#f59e0b}
.Completed{background:#22c55e}
.treatment{
  background:#f97316; /* orange */
}

/* MODAL STYLES */
.modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.6);
  justify-content:center;
  align-items:center;
  z-index:1000;
  overflow-y:auto;
  backdrop-filter:blur(2px);
}
.modal.active{display:flex}
.modal-content{
  background:linear-gradient(135deg, #ffffff 0%, #f0fdf9 100%);
  border-radius:20px;
  padding:0;
  max-width:700px;
  width:90%;
  box-shadow:0 25px 80px rgba(0,0,0,.25), 0 0 1px rgba(0,0,0,.1);
  margin:20px auto;
  border:1px solid rgba(15,118,110,.1);
  overflow:hidden;
}

body.dark .modal-content{
  background:linear-gradient(135deg, #111827 0%, #064e3b 100%);
  border:1px solid rgba(15,118,110,.3);
}

.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:26px 26px 20px;
  background:linear-gradient(135deg, var(--primary), var(--secondary));
  border-bottom:2px solid rgba(255,255,255,.1);
  color:white;
}
.modal-header h3{
  margin:0;
  font-size:22px;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:10px;
}
.close-modal{
  background:rgba(255,255,255,.15);
  border:none;
  font-size:28px;
  cursor:pointer;
  padding:4px 8px;
  color:white;
  border-radius:8px;
  transition:all 0.2s;
}
.close-modal:hover{
  background:rgba(255,255,255,.25);
  transform:rotate(90deg);
}

.modal-body{
  padding:26px;
  margin-bottom:0;
  overflow-y:auto;
  max-height:calc(100vh - 200px);
}

.modal-body label{
  font-weight:700;
  display:block;
  margin-bottom:8px;
  color:var(--primary);
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.form-group{
  margin-bottom:20px;
}

.form-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}

.form-row.full{
  grid-template-columns:1fr;
}

.modal-body input,.modal-body select,.modal-body textarea{
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  border:2px solid #cbd5e1;
  margin-bottom:0;
  font-size:14px;
  font-family:"Segoe UI", Arial;
  transition:all 0.3s;
  background:white;
  color:var(--text);
}

body.dark .modal-body input,
body.dark .modal-body select,
body.dark .modal-body textarea{
  background:#1f2937;
  border:2px solid #374151;
  color:#f9fafb;
}

.modal-body input:focus,.modal-body select:focus,.modal-body textarea:focus{
  border-color:var(--secondary);
  box-shadow:0 0 0 3px rgba(20,184,166,.1);
  outline:none;
}

.modal-body textarea{
  resize:none;
  min-height:100px;
}

.section-divider{
  padding:16px 0;
  margin:16px 0;
  border-top:2px dashed #e0f2f1;
  border-bottom:2px dashed #e0f2f1;
  font-weight:700;
  color:var(--primary);
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

body.dark .section-divider{
  border-top:2px dashed #064e3b;
  border-bottom:2px dashed #064e3b;
}

.modal-footer{
  display:flex;
  gap:12px;
  justify-content:flex-end;
  padding:20px 26px;
  background:linear-gradient(135deg, rgba(15,118,110,.05), rgba(20,184,166,.05));
  border-top:1px solid #cbd5e1;
}

body.dark .modal-footer{
  background:linear-gradient(135deg, rgba(15,118,110,.1), rgba(20,184,166,.1));
  border-top:1px solid #374151;
}

.modal-footer button{
  padding:12px 24px;
  font-size:14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  transition:all 0.3s;
  display:flex;
  align-items:center;
  gap:6px;
}

.modal-footer button:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 16px rgba(0,0,0,.15);
}

.modal-footer .cancel-btn{
  background:#e5e7eb;
  color:#374151;
  border:2px solid #cbd5e1;
}

.modal-footer .cancel-btn:hover{
  background:#d1d5db;
}

.modal-footer .save-btn{
  background:linear-gradient(135deg, var(--primary), var(--secondary));
  color:white;
  box-shadow:0 6px 16px rgba(15,118,110,.25);
}

</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h2><i class="fa-solid fa-hospital"></i> Sri Physiotherapy Clinic</h2>
  <div>
<button class="darkbtn" onclick="toggleDark()" id="darkToggle">
  <i class="fa-solid fa-moon"></i>
</button>
<!-- Doctor Appointments / Assignment -->
<button class="doctor" onclick="openDoctor()" title="Doctor Appointments">
  <i class="fa-solid fa-stethoscope"></i>
</button>

<!-- Doctor Master -->
<button class="doctor" onclick="openDoctorMaster()" title="Doctor Master">
  <i class="fa-solid fa-user-doctor"></i> 
</button>
    <button class="treatment" onclick="openTreatmentMaster()">
  <i class="fa-solid fa-notes-medical"></i>
</button>
<button class="doctor" onclick="openChangePasswordPage()" title="Change Password">
  <i class="fa-solid fa-key"></i>
</button>


    <button class="appoint" onclick="openAppointment()"><i class="fa-solid fa-calendar-check"></i></button>
    <button class="reports" onclick="openReportsHub()"><i class="fa-solid fa-chart-line"></i></button>
    <button class="logout" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></button>
  </div>
</div>

<!-- STATS -->
<div class="stats">
  <div class="stat"><h3 id="tTotal">0</h3><p>Total Patients</p></div>
  <div class="stat"><h3 id="tOngoing">0</h3><p>Ongoing</p></div>
  <div class="stat"><h3 id="tCompleted">0</h3><p>Completed</p></div>
  <div class="stat"><h3 id="tAmount">‚Çπ0</h3><p>Total Amount</p></div>
  <div class="stat"><h3 id="tPaid">‚Çπ0</h3><p>Total Payments</p></div>
  <div class="stat"><h3 id="tDailyPaid">‚Çπ0</h3><p>Today's Paid</p></div>
  <div class="stat"><h3 id="tDue">‚Çπ0</h3><p>Total Due</p></div>
</div>
<!-- DOCTOR REPORT BUTTON -->
<!-- DOCTOR REPORT BUTTON -->
<div style="
  max-width:1200px;
  margin:0 auto 16px;
  padding:0 20px;
  display:flex;
  justify-content:center;
">
  <button
    onclick="openDoctorReport()"
    style="
      background:#7c3aed;
      color:white;
      border:none;
      padding:12px 22px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.15);
    "
  >
    <i class="fa-solid fa-file-pdf"></i> Doctor-wise Report
  </button>
</div>


<!-- FILTER -->
<div class="filter">
  <input
    id="searchInput"
    placeholder="Search name / phone"
  >

  <select id="statusSelect">
    <option value="">All Status</option>
    <option value="Ongoing">Ongoing</option>
    <option value="Completed">Completed</option>
  </select>

  <select id="doctorSelect">
    <option value="">All Doctors</option>
  </select>

  <button onclick="loadPatients()">
    <i class="fa-solid fa-magnifying-glass"></i> Search
  </button>
</div>


<!-- PATIENT LIST -->
<div class="container">
  <div id="patientsContainer"></div>
</div>

<!-- EDIT PATIENT MODAL -->
<div id="editPatientModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fa-solid fa-user-pen"></i> Edit Patient Details</h3>
      <button class="close-modal" onclick="closeEditPatientModal()" title="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Personal Information Section -->
      <div class="section-divider"><i class="fa-solid fa-id-card"></i> Personal Information</div>
      
      <div class="form-row">
        <div class="form-group">
          <label><i class="fa-solid fa-user"></i> Patient Name *</label>
          <input type="text" id="editName" placeholder="Full name">
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-cake-candles"></i> Age</label>
          <input type="number" id="editAge" placeholder="Age" min="0" max="150">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label><i class="fa-solid fa-venus-mars"></i> Gender</label>
          <select id="editGender">
            <option value="">-- Select --</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-phone"></i> Phone *</label>
          <input type="tel" id="editPhone" placeholder="Phone number">
        </div>
      </div>
      
      <div class="form-group form-row full">
        <label><i class="fa-solid fa-map-location-dot"></i> Address</label>
        <textarea id="editAddress" placeholder="Street address, City, State, Postal Code"></textarea>
      </div>

      <!-- Medical Information Section -->
      <div class="section-divider"><i class="fa-solid fa-stethoscope"></i> Medical Information</div>
      
      <div class="form-group form-row full">
        <label><i class="fa-solid fa-triangle-exclamation"></i> Problem/Complaint</label>
        <textarea id="editProblem" placeholder="Patient's problem, injury, or complaint"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label><i class="fa-solid fa-user-doctor"></i> Recommended Doctor</label>
          <select id="editDoctor">
            <option value="">-- Select Doctor --</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-pills"></i> Treatment *</label>
          <select id="editTreatment">
            <option value="">-- Select Treatment --</option>
          </select>
        </div>
      </div>
      
      <div class="form-group form-row full">
        <label><i class="fa-solid fa-clipboard"></i> Additional Notes</label>
        <textarea id="editNotes" placeholder="Any additional medical notes or observations"></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" onclick="closeEditPatientModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
      <button class="save-btn" onclick="saveEditedPatient()"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
    </div>
  </div>
</div>

<script>
const token=localStorage.getItem("token");
if(!token) location.href="index.html";

let all=[];
let currentEditPatientId = null;

async function loadPatients(){
  const res=await fetch(
    `${API}/patients?search=${searchInput.value}&status=${statusSelect.value}&doctor=${doctorSelect.value}`,
    { headers:{Authorization:`Bearer ${token}`} }
  );
  all=await res.json();
  updateStats();
  render();
}

function updateStats(){
  let totalAmount=0, totalPaid=0, dailyPaid=0, totalDue=0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  all.forEach(p=>{
    totalAmount+=Number(p.totalAmount||0);
    totalPaid+=Number(p.paidAmount||0);
    totalDue+=Number(p.dueAmount||0);
    
    // Calculate today's payments
    if(p.paymentHistory){
      p.paymentHistory.forEach(ph=>{
        const paymentDate = new Date(ph.date);
        paymentDate.setHours(0, 0, 0, 0);
        if(paymentDate.getTime() === today.getTime() && ph.entryType === "Payment"){
          dailyPaid += Number(ph.amount||0);
        }
      });
    }
  });

  tTotal.innerText=all.length;
  tOngoing.innerText=all.filter(p=>p.status==="Ongoing").length;
  tCompleted.innerText=all.filter(p=>p.status==="Completed").length;

  tAmount.innerText="‚Çπ"+totalAmount.toLocaleString("en-IN");
  tPaid.innerText="‚Çπ"+totalPaid.toLocaleString("en-IN");
  tDailyPaid.innerText="‚Çπ"+dailyPaid.toLocaleString("en-IN");
  tDue.innerText="‚Çπ"+totalDue.toLocaleString("en-IN");
}
async function loadDoctors(){
  const res = await fetch(`${API}/doctors`,{
    headers:{ Authorization:`Bearer ${token}` }
  });

  const doctors = await res.json();

  doctorSelect.innerHTML =
    `<option value="">All Doctors</option>` +
    doctors.map(d => `<option value="${d.name}">${d.name}</option>`).join("");
}
loadDoctors();

function render(){
  patientsContainer.innerHTML=all.map(p=>`
    <div class="card">
      <div>
        <b>${p.name}</b> (${p.age||"-"})<br>
        üìû ${p.phone}<br>
        üë®‚Äç‚öïÔ∏è ${p.recommendedDoctor}<br>
        <span class="status ${p.status}">${p.status}</span>
      </div>
      <div>
        <button class="view-btn" onclick="openPatient('${p._id}')">View</button>
        <button class="edit-btn" onclick="openEditPatientModal('${p._id}')">‚úèÔ∏è Edit</button>
        <button class="delete-btn" onclick="deletePatientFromDashboard('${p._id}', '${p.name}')">üóë Delete</button>
      </div>
    </div>
  `).join("");
}

function openReportsHub() {
  location.href = "reports-dashboard.html";
}
async function deletePatientFromDashboard(id, name){
  if(confirm(`‚ö†Ô∏è Are you sure you want to delete ${name}? This action cannot be undone.`)){
    try {
      const response = await fetch(`${API}/patient/${id}`,{
        method:"DELETE",
        headers:{ Authorization:`Bearer ${token}` }
      });

      if (!response.ok) {
        alert("‚ùå Failed to delete patient");
        return;
      }

      alert("‚úÖ Patient deleted successfully");
      loadPatients();
    } catch (error) {
      console.error(error);
      alert("‚ùå Error deleting patient. Check console.");
    }
  }
}
function openPatient(id){
  location.href = `patient.html?id=${id}`;
}
function openDoctor() {
  location.href = "doctor.html";
}
function openAppointment() {
  location.href = "appointment.html";
}
function openDoctorReport() {
  location.href = "doctor-report.html";
}
function openTreatmentMaster() {
  location.href = "treatment-master.html";
}
function openDoctorMaster(){
  location.href="recommended-doctor.html";
}
function openChangePasswordPage(){
  location.href = "change-password.html";
}


function logout() {
  localStorage.clear();
  location.href = "index.html";
}

const darkToggle = document.getElementById("darkToggle");

function toggleDark(){
  document.body.classList.toggle("dark");

  const isDark = document.body.classList.contains("dark");
  localStorage.setItem("theme", isDark ? "dark" : "light");

  darkToggle.innerHTML = isDark
    ? '<i class="fa-solid fa-sun"></i>'
    : '<i class="fa-solid fa-moon"></i>';
}
const savedTheme = localStorage.getItem("theme");

if(savedTheme === "dark"){
  document.body.classList.add("dark");
  document.getElementById("darkToggle").innerHTML =
    '<i class="fa-solid fa-sun"></i>';
}

// EDIT PATIENT FUNCTIONS
async function loadTreatments(){
  try {
    const res = await fetch(`${API}/treatments`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const treatments = await res.json();
    
    const treatmentSelect = document.getElementById("editTreatment");
    treatmentSelect.innerHTML = `<option value="">-- Select Treatment --</option>` +
      treatments.map(t => `<option value="${t._id}">${t.name}</option>`).join("");
  } catch (error) {
    console.error("Error loading treatments:", error);
  }
}

async function openEditPatientModal(id){
  currentEditPatientId = id;
  await loadTreatments();
  
  // Fetch patient data
  try {
    const res = await fetch(`${API}/patient/${id}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const patient = await res.json();
    
    // Populate form fields
    document.getElementById("editName").value = patient.name || "";
    document.getElementById("editAge").value = patient.age || "";
    document.getElementById("editGender").value = patient.gender || "";
    document.getElementById("editPhone").value = patient.phone || "";
    document.getElementById("editAddress").value = patient.address || "";
    document.getElementById("editProblem").value = patient.problem || "";
    document.getElementById("editDoctor").value = patient.recommendedDoctor || "";
    document.getElementById("editNotes").value = patient.notes || "";
    document.getElementById("editTreatment").value = patient.treatment || "";
    
    // Open modal
    document.getElementById("editPatientModal").classList.add("active");
  } catch (error) {
    console.error(error);
    alert("‚ùå Error loading patient details");
  }
}

function closeEditPatientModal(){
  document.getElementById("editPatientModal").classList.remove("active");
  currentEditPatientId = null;
}

async function saveEditedPatient(){
  if(!currentEditPatientId){
    alert("‚ùå Patient ID not found");
    return;
  }
  
  const name = document.getElementById("editName").value.trim();
  const age = Number(document.getElementById("editAge").value) || 0;
  const gender = document.getElementById("editGender").value;
  const phone = document.getElementById("editPhone").value.trim();
  const address = document.getElementById("editAddress").value.trim();
  const problem = document.getElementById("editProblem").value.trim();
  const recommendedDoctor = document.getElementById("editDoctor").value;
  const notes = document.getElementById("editNotes").value.trim();
  const treatment = document.getElementById("editTreatment").value;
  
  // Validation
  if(!name){
    alert("‚ùå Patient name is required");
    return;
  }
  
  if(!phone){
    alert("‚ùå Phone number is required");
    return;
  }
  
  if(!treatment){
    alert("‚ùå Treatment is required");
    return;
  }
  
  try {
    const response = await fetch(`${API}/patient/${currentEditPatientId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({
        name,
        age,
        gender,
        phone,
        address,
        problem,
        recommendedDoctor,
        notes,
        treatment
      })
    });
    
    if(!response.ok){
      const error = await response.json();
      alert(`‚ùå ${error.message || 'Failed to update patient'}`);
      return;
    }
    
    alert("‚úÖ Patient details updated successfully");
    closeEditPatientModal();
    loadPatients();
  } catch (error) {
    console.error(error);
    alert("‚ùå Error saving patient details");
  }
}

loadPatients();
function openChangePassword(){
  document.getElementById("changeModal").style.display="flex";
}

function closeChange(){
  document.getElementById("changeModal").style.display="none";
}
</script>

</body>
</html>
