<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<script src="config.js"></script>
<title>Payment Dues & Reports</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
/* Duplicate body selector removed (see above for main body CSS) */

<style>
body {
  background: linear-gradient(120deg, #e0f7fa 60%, #f0fdfa 100%) no-repeat fixed;
}
.hospital-title {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.hospital-header {
  background: linear-gradient(135deg, #0f766e 80%, #14b8a6 100%);
  color: #fff;
  padding: 28px 32px 18px 32px;
  border-radius: 0 0 24px 24px;
  box-shadow: 0 8px 32px rgba(20,184,166,0.10);
  margin-bottom: 32px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.hospital-header .nav-btn {
  background: #fff;
  color: var(--primary);
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(20,184,166,0.08);
  transition: background 0.2s, color 0.2s;
}
.hospital-header .nav-btn:hover {
  background: var(--primary);
  color: #fff;
}
.payment-status-card {
  margin-top: 0;
}
:root{
  --primary:#0f766e;
  --secondary:#14b8a6;
  --bg:#e6f2f1;
  --card:#ffffff;
  --text:#1f2937;
}
*{box-sizing:border-box}
.header{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:white;
  padding:18px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header button{
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}

/* LAYOUT */
.container{
  max-width:1200px;
  margin:auto;
  padding:25px;
}
.card{
  background:var(--card);
  border-radius:14px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
  margin-bottom:20px;
}

/* FILTER */
.filter{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.filter select,.filter button{
  padding:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
.filter button{
  background:var(--primary);
  color:white;
  border:none;
  font-weight:600;
}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.stat{
  background:#f8fafc;
  border-left:6px solid var(--primary);
  padding:18px;
  border-radius:10px;
}

/* ACTIONS */
.actions{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:12px;
}
.actions button{
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.excel{background:#1d4ed8;color:white}
.print{background:#166534;color:white} /* Improved contrast */

canvas{max-height:320px}

/* DAILY REPORT TABLE STYLES */
#dailyReportTable tbody tr{
  border-bottom:1px solid #e5e7eb;
  transition:all 0.2s;
}

#dailyReportTable tbody tr:hover{
  background:#f0fdf9;
}

#dailyReportTable td{
  padding:12px;
  border:1px solid #e5e7eb;
  font-size:14px;
}

#dailyReportTable thead th{
  font-weight:700;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.daily-total{
  font-weight:700;
  color:var(--primary);
}

.daily-paid{
  color:#16a34a;
  font-weight:600;
}

.daily-due{
  color:#dc2626;
  font-weight:600;
}

@media print{
  .header,.filter,.actions{display:none}
}
</style>
</head>

<body>

<div class="hospital-header">
  <span class="hospital-title"><i class="fa-solid fa-hospital"></i> Sri Physiotherapy Clinic Reports</span>
  <button class="nav-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i> Dashboard</button>
</div>

<div class="container">
  <!-- OVERALL STATS MOVED FROM DASHBOARD -->
  <div class="card">
    <h3>ðŸ“Š Overall Clinic Stats</h3>
    <div class="stats">
      <div class="stat"><h3 id="tAmount">â‚¹0</h3><p>Total Amount</p></div>
      <div class="stat"><h3 id="tPaid">â‚¹0</h3><p>Total Payments</p></div>
      <div class="stat"><h3 id="tDailyPaid">â‚¹0</h3><p>Today's Paid</p></div>
      <div class="stat"><h3 id="tDue">â‚¹0</h3><p>Total Due</p></div>
    </div>
  </div>

  <!-- MONTHLY -->
  <div class="card">
    <h3 style="display:flex;align-items:center;gap:10px;color:var(--primary)"><i class="fa-solid fa-calendar-days"></i> Monthly Summary</h3>
    <div class="filter" style="margin-bottom:18px;">
      <select id="month">
        <option value="0">January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>
      <select id="year"></select>
      <button onclick="generateReports()">Show Report</button>
    </div>
    <div id="monthlyStats" class="stats"></div>
    <div id="monthlyChartEmpty" style="text-align:center;color:#888;padding:40px 0;display:none;">No monthly data available for this period.</div>
  </div>

  <div class="card">
    <canvas id="monthlyChart"></canvas>
    <canvas id="dateIncomeChart" style="margin-top:32px;"></canvas>
    <div id="dateIncomeTableContainer" style="margin-top:24px;"></div>
  </div>

  <!-- DAILY WISE GROUP REPORT -->
  <div class="card">
    <h3 style="display:flex;align-items:center;gap:10px;color:var(--primary)"><i class="fa-solid fa-chart-column"></i> Daily Wise Group Report for Month</h3>
    <div id="dailyReportContainer" style="overflow-x:auto;">
      <table id="dailyReportTable" style="width:100%;border-collapse:collapse;margin-top:15px;">
        <thead>
          <tr style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;">
            <th style="padding:12px;text-align:left;border:1px solid #ddd;">Date</th>
            <th style="padding:12px;text-align:center;border:1px solid #ddd;">Patients Treated</th>
            <th style="padding:12px;text-align:center;border:1px solid #ddd;">Total Amount (â‚¹)</th>
            <th style="padding:12px;text-align:center;border:1px solid #ddd;">Paid Amount (â‚¹)</th>
            <th style="padding:12px;text-align:center;border:1px solid #ddd;">Due Amount (â‚¹)</th>
            <th style="padding:12px;text-align:center;border:1px solid #ddd;">Payment Count</th>
          </tr>
        </thead>
        <tbody id="dailyReportBody">
          <tr><td colspan="6" style="text-align:center;padding:20px;color:#999;">Generate report to see daily data</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- YEARLY -->
  <div class="card">
    <h3 style="display:flex;align-items:center;gap:10px;color:var(--primary)"><i class="fa-solid fa-calendar"></i> Yearly Summary</h3>
    <div id="yearlyStats" class="stats"></div>
    <div id="yearlyChartEmpty" style="text-align:center;color:#888;padding:40px 0;display:none;">No yearly data available for this period.</div>
  </div>

  <div class="card">
    <canvas id="yearlyChart"></canvas>
  </div>

  <div class="actions">
    <button class="excel" onclick="downloadExcel()">ðŸ“¥ Excel</button>
    <button class="print" onclick="window.print()">ðŸ–¨ Print</button>
  </div>

</div>

<script>
// Populate year dropdown (only once, avoid redeclaration)
if (globalThis._yearDropdownPopulated === undefined) {
  globalThis._yearDropdownPopulated = true;
  var yearSelect = document.getElementById('year');
  var cy = new Date().getFullYear();
  for(let y=cy-5;y<=cy+5;y++){
    yearSelect.innerHTML += `<option value="${y}"${y===cy ? ' selected' : ''}>${y}</option>`;
  }
}

// Date vs Income Chart
let dateIncomeChart = null;

function renderDateIncomeChartAndTable(dailyDetails, month, year) {
  const ctx = document.getElementById('dateIncomeChart').getContext('2d');
  const days = Object.keys(dailyDetails).sort((a,b)=>Number(a)-Number(b));
  const labels = days.map(day => `${day}-${Number(month)+1}-${year}`);
  const incomeData = days.map(day => dailyDetails[day].paidAmount || 0);

  if(dateIncomeChart) dateIncomeChart.destroy();
  dateIncomeChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Income (â‚¹)',
        data: incomeData,
        borderColor: '#0f766e',
        backgroundColor: 'rgba(20,184,166,0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { x: { title: { display: true, text: 'Date' } }, y: { title: { display: true, text: 'Income (â‚¹)' } } }
    }
  });

  // Table
  let tableHtml = '<table style="width:100%;border-collapse:collapse;margin-top:10px;">';
  tableHtml += '<thead><tr style="background:#e0f7fa;color:#0f766e;font-weight:700;"><th style="padding:10px;border:1px solid #ddd;">Date</th><th style="padding:10px;border:1px solid #ddd;">Income (â‚¹)</th></tr></thead><tbody>';
  if(days.length) {
    days.forEach((day, idx) => {
      tableHtml += `<tr><td style="padding:10px;border:1px solid #eee;">${labels[idx]}</td><td style="padding:10px;border:1px solid #eee;">â‚¹${dailyDetails[day].paidAmount.toLocaleString('en-IN')}</td></tr>`;
    });
  } else {
    tableHtml += '<tr><td colspan="2" style="text-align:center;padding:18px;color:#888;">No daily income data for this month.</td></tr>';
  }
  tableHtml += '</tbody></table>';
  document.getElementById('dateIncomeTableContainer').innerHTML = tableHtml;
}
// OVERALL CLINIC STATS LOGIC (was payment status)
async function loadOverallClinicStats() {
  const token = localStorage.getItem("token");
  if (!token) return;
  const res = await fetch(`${API}/patients`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const patients = await res.json();
  let totalAmount = 0, totalPayments = 0, totalDue = 0, todayPaid = 0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  patients.forEach(p => {
    totalAmount += Number(p.totalAmount || 0);
    totalPayments += Number(p.paidAmount || 0);
    totalDue += Number(p.dueAmount || 0);
    if (p.paymentHistory) {
      p.paymentHistory.forEach(ph => {
        const paymentDate = new Date(ph.date);
        paymentDate.setHours(0, 0, 0, 0);
        if (paymentDate.getTime() === today.getTime() && ph.entryType === "Payment") {
          todayPaid += Number(ph.amount || 0);
        }
      });
    }
  });
  document.getElementById("tAmount").innerText = "â‚¹" + totalAmount.toLocaleString("en-IN");
  document.getElementById("tPaid").innerText = "â‚¹" + totalPayments.toLocaleString("en-IN");
  document.getElementById("tDailyPaid").innerText = "â‚¹" + todayPaid.toLocaleString("en-IN");
  document.getElementById("tDue").innerText = "â‚¹" + totalDue.toLocaleString("en-IN");
}
// AUTO-SELECT CURRENT MONTH AND YEAR, SHOW GRAPH
globalThis.addEventListener('DOMContentLoaded', () => {
  loadOverallClinicStats();
  const now = new Date();
  const month = now.getMonth();
  const year = now.getFullYear();
  // Set month and year dropdowns if present
  const monthSelect = document.getElementById('month');
  const yearSelect = document.getElementById('year');
  if(monthSelect && yearSelect) {
    monthSelect.value = String(month);
    let found = false;
    for(let i=0; i<yearSelect.options.length; i++) {
      if(yearSelect.options[i].value == year) {
        yearSelect.selectedIndex = i;
        found = true;
        break;
      }
    }
    if(!found) yearSelect.selectedIndex = 0;
    generateReports();
  }
});
const token=localStorage.getItem("token");
if(!token) location.href="index.html";

// Year dropdown logic moved above to avoid duplicate declarations

// Chart elements
const monthlyChartEl=document.getElementById("monthlyChart");
const yearlyChartEl=document.getElementById("yearlyChart");

let monthlyChart=null;
let yearlyChart=null;

async function generateReports(){
  const monthVal=document.getElementById("month").value;
  const yearVal=document.getElementById("year").value;

  if(monthVal===""){ alert("Select month"); return; }

  const res=await fetch(`${API}/patients`,{
    headers:{Authorization:`Bearer ${token}`}
  });
  const patients=await res.json();

  let mTotal=0,mPaid=0,mDue=0,mCount=0;
  let yTotal=0,yPaid=0,yDue=0,yCount=0;
  let daily={}, yearly={};
  let dailyDetails = {}; // Store detailed data for each day

  patients.forEach(p=>{
    const d=new Date(p.appointmentDate || p.createdAt);
    const due=(p.totalAmount||0)-(p.paidAmount||0);

    if(d.getFullYear()==yearVal){
      yTotal+=p.totalAmount||0;
      yPaid+=p.paidAmount||0;
      if(due>0) yDue+=due;
      yCount++;
      yearly[d.getMonth()]=(yearly[d.getMonth()]||0)+(p.paidAmount||0);
    }

    if(d.getMonth()==Number(monthVal) && d.getFullYear()==Number(yearVal)){
      mTotal+=p.totalAmount||0;
      mPaid+=p.paidAmount||0;
      if(due>0) mDue+=due;
      mCount++;
      daily[d.getDate()]=(daily[d.getDate()]||0)+(p.paidAmount||0);

      // âœ… STORE DAILY DETAILS
      const dayKey = d.getDate();
      if(!dailyDetails[dayKey]){
        dailyDetails[dayKey] = {
          date: d.toLocaleDateString('en-IN'),
          patients: 0,
          totalAmount: 0,
          paidAmount: 0,
          dueAmount: 0,
          paymentCount: 0
        };
      }
      
      dailyDetails[dayKey].patients += 1;
      dailyDetails[dayKey].totalAmount += p.totalAmount || 0;
      dailyDetails[dayKey].paidAmount += p.paidAmount || 0;
      dailyDetails[dayKey].dueAmount += due;
      
      // Count payments for this patient
      if(p.paymentHistory){
        p.paymentHistory.forEach(payment => {
          const paymentDate = new Date(payment.date);
          if(paymentDate.getDate() === dayKey && paymentDate.getMonth() === Number(monthVal) && paymentDate.getFullYear() === Number(yearVal)){
            dailyDetails[dayKey].paymentCount += 1;
          }
        });
      }
    }
  });
  // Render date vs income chart and table
  renderDateIncomeChartAndTable(dailyDetails, monthVal, yearVal);

  monthlyStats.innerHTML=`
    <div class="stat"><h3>${mCount}</h3><p>Patients</p></div>
    <div class="stat"><h3>â‚¹${mTotal}</h3><p>Total</p></div>
    <div class="stat"><h3>â‚¹${mPaid}</h3><p>Collected</p></div>
    <div class="stat"><h3>â‚¹${mDue}</h3><p>Due</p></div>
  `;

  // âœ… RENDER DAILY WISE REPORT TABLE
  const dailyReportBody = document.getElementById("dailyReportBody");
  const sortedDays = Object.keys(dailyDetails).sort((a,b) => Number.parseInt(a) - Number.parseInt(b));
  
  if(sortedDays.length > 0){
    dailyReportBody.innerHTML = sortedDays.map(day => {
      const data = dailyDetails[day];
      return `
        <tr>
          <td style="font-weight:600;color:var(--primary);">${data.date}</td>
          <td>${data.patients}</td>
          <td>â‚¹${data.totalAmount.toLocaleString('en-IN')}</td>
          <td>â‚¹${data.paidAmount.toLocaleString('en-IN')}</td>
          <td>â‚¹${data.dueAmount.toLocaleString('en-IN')}</td>
          <td>${data.paymentCount}</td>
        </tr>
      `;
    }).join('');
  } else {
    dailyReportBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;color:#999;">No data for this month</td></tr>`;
  }

  yearlyStats.innerHTML = `
    <div class="stat"><h3>${yCount}</h3><p>Patients</p></div>
    <div class="stat"><h3>â‚¹${yTotal}</h3><p>Total</p></div>
    <div class="stat"><h3>â‚¹${yPaid}</h3><p>Collected</p></div>
    <div class="stat"><h3>â‚¹${yDue}</h3><p>Due</p></div>
  `;

  if(monthlyChart) monthlyChart.destroy();
  monthlyChart = new Chart(monthlyChartEl, {
    type: "bar",
    data: {
      labels: Object.keys(daily),
      datasets: [{ label: "Daily Collection", data: Object.values(daily), backgroundColor: "#0f766e" }]
    }
  });

  if(yearlyChart) yearlyChart.destroy();
  yearlyChart = new Chart(yearlyChartEl, {
    type: "line",
    data: {
      labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      datasets: [{ label: "Monthly Collection", data: Object.values(yearly), borderColor: "#14b8a6" }]
    }
  });
}
function downloadExcel(){
  const monthVal = document.getElementById("month").value;
  const yearVal  = document.getElementById("year").value;
  const token    = localStorage.getItem("token");

  if(monthVal === ""){
    alert("Select month");
    return;
  }

  window.open(
    `${API}/report/monthly/excel?month=${Number(monthVal)+1}&year=${yearVal}&token=${token}`
  );
}

function goBack(){ location.href="dashboard.html"; }

// Show empty chart messages if no data
function showEmptyChartMessages(monthlyData, yearlyData) {
  document.getElementById('monthlyChartEmpty').style.display = monthlyData && monthlyData.length ? 'none' : '';
  document.getElementById('yearlyChartEmpty').style.display = yearlyData && yearlyData.length ? 'none' : '';
}

// Patch generateReports to show empty chart messages
const originalGenerateReports = generateReports;
generateReports = async function() {
  await originalGenerateReports.apply(this, arguments);
  // Get monthly and yearly data from charts
  let monthlyData = monthlyChart && monthlyChart.data && monthlyChart.data.datasets[0] ? monthlyChart.data.datasets[0].data : [];
  let yearlyData = yearlyChart && yearlyChart.data && yearlyChart.data.datasets[0] ? yearlyChart.data.datasets[0].data : [];
  showEmptyChartMessages(monthlyData, yearlyData);
}
</script>

</body>
</html>
